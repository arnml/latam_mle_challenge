name: Continuous Deployment

on:
  push:
    branches:
      - main
jobs:  
  build:
    runs-on: ubuntu-latest  
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    - name: Test secrets
      run: echo "SECRET IS ${{ secrets.PROVIDER }}"
    - name: Set up Cloud SDK
      uses: google-github-actions/auth@v2
      with:
        project_id: ${{ secrets.PROJECT }}
        workload_identity_provider: '${{ secrets.PROVIDER}}'
      

    # - name: Authenticate Docker with GCR
    #   run: |
    #     echo "${{ secrets.PR }}" | docker login -u _json_key --password-stdin https://gcr.io

    # - name: Build Docker image
    #   run: |
    #     docker build -t gcr.io/${{ secrets.GCP_PROJECT }}/${{ secrets.CLOUD_RUN_SERVICE_NAME }}:latest .

  # deploy-test:
  #   runs-on: ubuntu-latest

  #   steps:
  #   - name: Checkout code
  #     uses: actions/checkout@v4

  #   - name: Set up Python
  #     uses: actions/setup-python@v4
  #     with:
  #       python-version: '3.12'

  #   - name: Install dependencies
  #     run: |
  #       python -m pip install --upgrade pip
  #       pip install -r requirements.txt

  #   # - name: Set up Google Cloud SDK
  #   #   uses: google-github-actions/setup-gcloud@v1
  #   #   with:
  #   #     project_id: ${{ secrets.GCP_PROJECT }}
  #   #     service_account_key: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
  #   #     export_default_credentials: true

  #   # - name: Build and push Docker image
  #   #   run: |
  #   #     gcloud builds submit --tag gcr.io/${{ secrets.GCP_PROJECT }}/fastapi-app

  #   # - name: Deploy to Cloud Run
  #   #   run: |
  #   #     gcloud run deploy fastapi-app \
  #   #       --image gcr.io/${{ secrets.GCP_PROJECT }}/fastapi-app \
  #   #       --platform managed \
  #   #       --allow-unauthenticated \
  #   #       --region ${{ secrets.GCP_REGION }}

  #   - name: Run stress API tests
  #     run: make stress-test
